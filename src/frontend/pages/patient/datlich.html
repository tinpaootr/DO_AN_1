<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt Lịch Khám - Eden Health</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-purple: #667eea;
            --secondary-purple: #764ba2;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 20px;
        }

        /* Navbar */
        .navbar-custom {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
        }

        .navbar-brand-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-purple) !important;
            text-decoration: none;
        }

        .navbar-brand-header i {
            color: var(--secondary-purple);
        }

        .nav-link-header {
            color: #333 !important;
            font-weight: 500;
            margin: 0 8px;
            padding: 8px 12px !important;
            text-decoration: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-purple);
            font-weight: 600;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-purple));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Booking Container */
        .booking-wrapper {
            max-width: 1100px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .booking-card {
            background: #fff;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .booking-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            text-align: center;
            color: white;
        }

        .booking-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .booking-body {
            padding: 40px;
        }

        /* Step Indicator */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .step-indicator::before {
            content: "";
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 3px;
            background: #e0e0e0;
            z-index: 0;
        }

        .progress-line {
            position: absolute;
            top: 20px;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-purple), var(--secondary-purple));
            transition: width 0.3s ease;
            z-index: 1;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .step-circle {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step.active .step-circle,
        .step.completed .step-circle {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-purple));
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .step-label {
            font-size: 0.85rem;
            color: #999;
            font-weight: 500;
        }

        .step.active .step-label,
        .step.completed .step-label {
            color: var(--primary-purple);
            font-weight: 600;
        }

        /* Section */
        .section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--primary-purple);
            display: inline-block;
        }

        /* Selection Grid */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .selection-card {
            border: 2px solid #e0e0e0;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: #fafafa;
            position: relative;
        }

        .selection-card:hover {
            border-color: var(--primary-purple);
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }

        .selection-card.selected {
            border-color: var(--primary-purple);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-purple));
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin-bottom: 16px;
        }

        .card-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 8px;
        }

        .card-subtitle {
            font-size: 0.9rem;
            color: #666;
        }

        .check-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary-purple);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .selection-card.selected .check-icon {
            display: flex;
        }

        /* Doctor Grid */
        .doctor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .doctor-card {
            border: 2px solid #e0e0e0;
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .doctor-card:hover {
            border-color: var(--primary-purple);
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }

        .doctor-card.selected {
            border-color: var(--primary-purple);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .doctor-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .doctor-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-purple));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 12px;
        }

        .doctor-name {
            font-weight: 700;
            font-size: 1rem;
            color: #333;
        }

        .doctor-specialty {
            font-size: 0.85rem;
            color: #666;
        }

        /* Time Slots */
        .shift-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .shift-btn {
            flex: 1;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
        }

        .shift-btn:hover {
            border-color: var(--primary-purple);
            background: rgba(102, 126, 234, 0.05);
        }

        .shift-btn.selected {
            border-color: var(--primary-purple);
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-purple));
            color: white;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .time-slot {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            font-weight: 600;
            color: #333;
        }

        .time-slot:hover:not(.disabled) {
            border-color: var(--primary-purple);
            transform: translateY(-5px);
        }

        .time-slot.selected {
            border-color: var(--primary-purple);
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-purple));
            color: white;

        }

        .time-slot.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            gap: 16px;
        }

        .btn-custom {
            padding: 14px 32px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-prev {
            background: #e0e0e0;
            color: #666;
        }

        .btn-prev:hover {
            background: #d0d0d0;
        }

        .btn-next, .btn-submit {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-purple));
            color: white;
        }

        .btn-next:hover, .btn-submit:hover {
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        .btn-next:disabled, .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Summary */
        .summary-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 600;
            color: #666;
        }

        .summary-value {
            font-weight: 700;
            color: #333;
        }

        .form-control {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px;
        }

        .form-control:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner-border {
            color: var(--primary-purple);
        }

        @media (max-width: 768px) {
            .booking-header h1 { font-size: 1.5rem; }
            .booking-body { padding: 24px; }
            .selection-grid, .doctor-grid { grid-template-columns: 1fr; }
            .time-slots { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
        <div class="container">
            <a class="navbar-brand-header" href="index.html">
                <i class="fas fa-clinic-medical me-2"></i>
                <span>Eden</span> Health
            </a>
            <div class="ms-auto user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userName">Người dùng</span>
            </div>
        </div>
    </nav>

    <!-- Booking Container -->
    <div class="booking-wrapper">
        <div class="booking-card">
            <div class="booking-header">
                <h1><i class="fas fa-calendar-check"></i> Đặt Lịch Khám</h1>
                <p>Hoàn thành các bước đơn giản để đặt lịch khám</p>
            </div>

            <div class="booking-body">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="progress-line" id="progressLine"></div>
                    <div class="step active" data-step="1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Gói Khám</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Khoa</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Chuyên Khoa</div>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Ngày & Bác Sĩ</div>
                    </div>
                    <div class="step" data-step="5">
                        <div class="step-circle">5</div>
                        <div class="step-label">Giờ Khám</div>
                    </div>
                    <div class="step" data-step="6">
                        <div class="step-circle">6</div>
                        <div class="step-label">Xác Nhận</div>
                    </div>
                </div>

                <!-- Step 1: Gói Khám -->
                <div class="section active" id="step1">
                    <h2 class="section-title">Chọn Gói Khám</h2>
                    <div class="selection-grid" id="packageGrid"></div>
                    <div class="nav-buttons">
                        <button class="btn-custom btn-prev" style="visibility: hidden">
                            <i class="fas fa-arrow-left"></i> Quay Lại
                        </button>
                        <button class="btn-custom btn-next" id="btnStep1Next" disabled>
                            Tiếp Theo <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Khoa -->
                <div class="section" id="step2">
                    <h2 class="section-title">Chọn Khoa Khám</h2>
                    <div class="selection-grid" id="departmentGrid"></div>
                    <div class="nav-buttons">
                        <button class="btn-custom btn-prev" onclick="goToStep(1)">
                            <i class="fas fa-arrow-left"></i> Quay Lại
                        </button>
                        <button class="btn-custom btn-next" id="btnStep2Next" disabled>
                            Tiếp Theo <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Chuyên Khoa -->
                <div class="section" id="step3">
                    <h2 class="section-title">Chọn Chuyên Khoa</h2>
                    <div class="selection-grid" id="specialtyGrid"></div>
                    <div class="nav-buttons">
                        <button class="btn-custom btn-prev" onclick="goToStep(2)">
                            <i class="fas fa-arrow-left"></i> Quay Lại
                        </button>
                        <button class="btn-custom btn-next" id="btnStep3Next" disabled>
                            Tiếp Theo <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Ngày & Bác Sĩ -->
                <div class="section" id="step4">
                    <h2 class="section-title">Chọn Ngày Khám</h2>
                    <div class="mb-4">
                        <input type="date" class="form-control" id="appointmentDate">
                    </div>
                    <h2 class="section-title">Chọn Bác Sĩ</h2>
                    <div class="doctor-grid" id="doctorGrid"></div>
                    <div class="nav-buttons">
                        <button class="btn-custom btn-prev" onclick="goToStep(3)">
                            <i class="fas fa-arrow-left"></i> Quay Lại
                        </button>
                        <button class="btn-custom btn-next" id="btnStep4Next" disabled>
                            Tiếp Theo <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 5: Giờ Khám -->
                <div class="section" id="step5">
                    <h2 class="section-title">Chọn Ca Làm Việc</h2>
                    <div class="shift-selector" id="shiftSelector"></div>
                    <h2 class="section-title">Chọn Suất Khám</h2>
                    <div class="time-slots" id="timeSlots"></div>
                    <div class="nav-buttons">
                        <button class="btn-custom btn-prev" onclick="goToStep(4)">
                            <i class="fas fa-arrow-left"></i> Quay Lại
                        </button>
                        <button class="btn-custom btn-next" id="btnStep5Next" disabled>
                            Tiếp Theo <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 6: Xác Nhận -->
                <div class="section" id="step6">
                    <h2 class="section-title">Xác Nhận Thông Tin</h2>
                    <div class="summary-card" id="summaryCard"></div>
                    <div class="mb-4">
                        <label class="form-label">Ghi chú (không bắt buộc)</label>
                        <textarea class="form-control" rows="4" id="notes" placeholder="Nhập ghi chú hoặc yêu cầu đặc biệt..."></textarea>
                    </div>
                    <div class="nav-buttons">
                        <button class="btn-custom btn-prev" onclick="goToStep(5)">
                            <i class="fas fa-arrow-left"></i> Quay Lại
                        </button>
                        <button class="btn-custom btn-submit" onclick="submitBooking()">
                            <i class="fas fa-check-circle"></i> Xác Nhận Đặt Lịch
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost/DO_AN_1/code_doan1/src/backend/api/patient';

        // State quản lý booking
        const bookingState = {
            packageId: null,
            departmentId: null,
            specialtyId: null,
            date: null,
            doctorId: null,
            shiftId: null,
            slotId: null,
            patientId: null
        };

        // Khởi tạo
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadPackages();
            setupDateInput();
            
            // Check URL params cho package
            const urlParams = new URLSearchParams(window.location.search);
            const packageParam = urlParams.get('package');
            if (packageParam) {
                bookingState.packageId = parseInt(packageParam);
            }
        });

        // Kiểm tra đăng nhập
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/check-auth.php`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (!data.success || data.role !== 'benhnhan') {
                    alert('Vui lòng đăng nhập với tài khoản bệnh nhân để đặt lịch!');
                    window.location.href = '../auth/login.html';
                    return;
                }
                
                bookingState.patientId = data.patientId;
                document.getElementById('userName').textContent = data.fullName || data.username;
                document.getElementById('userAvatar').textContent = (data.fullName || data.username).charAt(0).toUpperCase();
                
            } catch (error) {
                console.error('Auth error:', error);
                alert('Phiên đăng nhập hết hạn. Vui lòng đăng nhập lại!');
                window.location.href = '../auth/login.html';
            }
        }

        // Setup date input - chỉ cho phép chọn ngày từ hôm nay
        function setupDateInput() {
            const dateInput = document.getElementById('appointmentDate');
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
            
            dateInput.addEventListener('change', function() {
                if (this.value && bookingState.specialtyId) {
                    bookingState.date = this.value;
                    loadAvailableDoctors();
                }
            });
        }

        // === LOAD DATA FUNCTIONS ===

        // Load gói khám
        async function loadPackages() {
            try {
                const response = await fetch(`${API_BASE}/get-packages.php`);
                const data = await response.json();
                
                if (data.success) {
                    renderPackages(data.data);
                    
                    // Auto-select nếu có packageId từ URL
                    if (bookingState.packageId) {
                        setTimeout(() => selectPackage(bookingState.packageId), 100);
                    }
                }
            } catch (error) {
                console.error('Error loading packages:', error);
            }
        }

        // Load khoa
        async function loadDepartments() {
            try {
                const response = await fetch(`${API_BASE}/get-departments.php`);
                const data = await response.json();
                
                if (data.success) {
                    renderDepartments(data.data);
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        // Load chuyên khoa theo khoa
        async function loadSpecialties(departmentId) {
            try {
                const response = await fetch(`${API_BASE}/get-specialties.php?maKhoa=${departmentId}`);
                const data = await response.json();
                
                if (data.success) {
                    renderSpecialties(data.data);
                }
            } catch (error) {
                console.error('Error loading specialties:', error);
            }
        }

        // Load bác sĩ khả dụng theo ngày và chuyên khoa
        async function loadAvailableDoctors() {
            const container = document.getElementById('doctorGrid');
            container.innerHTML = '<div class="loading"><div class="spinner-border"></div><p>Đang tải...</p></div>';
            
            try {
                const response = await fetch(
                    `${API_BASE}/get-available-doctors.php?maChuyenKhoa=${bookingState.specialtyId}&ngayKham=${bookingState.date}`
                );
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    renderDoctors(data.data);
                } else {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-user-md"></i><p>Không có bác sĩ khả dụng trong ngày này</p></div>';
                }
            } catch (error) {
                console.error('Error loading doctors:', error);
                container.innerHTML = '<div class="empty-state text-danger"><i class="fas fa-exclamation-circle"></i><p>Lỗi tải dữ liệu</p></div>';
            }
        }

        // Load ca làm việc khả dụng
        async function loadShifts() {
            try {
                const response = await fetch(
                    `${API_BASE}/get-available-shifts.php?maBacSi=${bookingState.doctorId}&ngayKham=${bookingState.date}`
                );
                const data = await response.json();
                
                if (data.success) {
                    renderShifts(data.data);
                }
            } catch (error) {
                console.error('Error loading shifts:', error);
            }
        }

        // Load suất khám khả dụng
        async function loadAvailableSlots(shiftId) {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '<div class="loading"><div class="spinner-border"></div></div>';
            
            try {
                const response = await fetch(
                    `${API_BASE}/get-available-slots.php?maBacSi=${bookingState.doctorId}&ngayKham=${bookingState.date}&maCa=${shiftId}`
                );
                const data = await response.json();
                
                if (data.success) {
                    renderTimeSlots(data.data);
                } else {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-clock"></i><p>Không có suất khám khả dụng</p></div>';
                }
            } catch (error) {
                console.error('Error loading slots:', error);
                container.innerHTML = '<div class="empty-state text-danger"><i class="fas fa-exclamation-circle"></i><p>Lỗi tải dữ liệu</p></div>';
            }
        }

        // === RENDER FUNCTIONS ===

        function renderPackages(packages) {
            const container = document.getElementById('packageGrid');
            container.innerHTML = packages.map(pkg => `
                <div class="selection-card" data-id="${pkg.maGoi}" onclick="selectPackage(${pkg.maGoi})">
                    <div class="card-icon"><i class="fas ${pkg.maGoi === 1 ? 'fa-heartbeat' : 'fa-user-md'}"></i></div>
                    <div class="card-title">${pkg.tenGoi}</div>
                    <div class="card-subtitle">${Number(pkg.gia).toLocaleString('vi-VN')}đ</div>
                    <div class="check-icon"><i class="fas fa-check"></i></div>
                </div>
            `).join('');
        }

        function renderDepartments(departments) {
            const container = document.getElementById('departmentGrid');
            container.innerHTML = departments.map(dept => `
                <div class="selection-card" data-id="${dept.maKhoa}" onclick="selectDepartment('${dept.maKhoa}')">
                    <div class="card-icon"><i class="fas fa-hospital"></i></div>
                    <div class="card-title">${dept.tenKhoa}</div>
                    <div class="check-icon"><i class="fas fa-check"></i></div>
                </div>
            `).join('');
        }

        function renderSpecialties(specialties) {
            const container = document.getElementById('specialtyGrid');
            container.innerHTML = specialties.map(spec => `
                <div class="selection-card" data-id="${spec.maChuyenKhoa}" onclick="selectSpecialty('${spec.maChuyenKhoa}')">
                    <div class="card-icon"><i class="fas fa-stethoscope"></i></div>
                    <div class="card-title">${spec.tenChuyenKhoa}</div>
                    <div class="check-icon"><i class="fas fa-check"></i></div>
                </div>
            `).join('');
        }

        function renderDoctors(doctors) {
            const container = document.getElementById('doctorGrid');
            container.innerHTML = doctors.map(doc => {
                const unavailableClass = doc.available ? '' : 'disabled';
                const unavailableBadge = doc.available ? '' : '<div style="background: #ff4d4f; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; margin-top: 8px;">Không khả dụng</div>';
                const onclick = doc.available ? `onclick="selectDoctor('${doc.maBacSi}')"` : '';
                
                return `
                <div class="doctor-card ${unavailableClass}" data-id="${doc.maBacSi}" ${onclick} style="${doc.available ? '' : 'opacity: 0.5; cursor: not-allowed;'}">
                    <div class="doctor-header">
                        <div class="doctor-avatar"><i class="fas fa-user-md"></i></div>
                        <div>
                            <div class="doctor-name">${doc.tenBacSi}</div>
                            <div class="doctor-specialty">${doc.tenChuyenKhoa || 'Đa khoa'}</div>
                        </div>
                    </div>
                    ${unavailableBadge}
                </div>
                `;
            }).join('');
        }

        function renderShifts(shifts) {
            const container = document.getElementById('shiftSelector');
            container.innerHTML = shifts.map(shift => {
                // Tất cả ca đều khả dụng ban đầu (sẽ check khi chọn)
                return `
                <div class="shift-btn" data-shift="${shift.maCa}" onclick="selectShift(${shift.maCa})">
                    <i class="fas ${shift.maCa === 1 ? 'fa-sun' : 'fa-cloud-sun'}"></i> ${shift.tenCa}<br>
                    <small>${shift.gioBatDau.substring(0, 5)} - ${shift.gioKetThuc.substring(0, 5)}</small>
                </div>
                `;
            }).join('');
        }

        function renderTimeSlots(slots) {
            const container = document.getElementById('timeSlots');
            container.innerHTML = slots.map(slot => {
                const unavailableClass = slot.available ? '' : 'disabled';
                const onclick = slot.available ? `onclick="selectSlot(${slot.maSuat})"` : '';
                const unavailableText = slot.available ? '' : '<small style="color: #ff4d4f; display: block; margin-top: 4px;">Đã đặt</small>';
                
                return `
                <div class="time-slot ${unavailableClass}" 
                    data-slot="${slot.maSuat}" 
                    ${onclick}>
                    <i class="fas fa-clock"></i>
                    <div>${slot.gioBatDau.substring(0, 5)} - ${slot.gioKetThuc.substring(0, 5)}</div>
                    ${unavailableText}
                </div>
                `;
            }).join('');
        }

        // === SELECTION HANDLERS ===

        function selectPackage(packageId) {
            bookingState.packageId = packageId;
            document.querySelectorAll('#packageGrid .selection-card').forEach(card => {
                card.classList.toggle('selected', parseInt(card.dataset.id) === packageId);
            });
            document.getElementById('btnStep1Next').disabled = false;
        }

        function selectDepartment(departmentId) {
            bookingState.departmentId = departmentId;
            bookingState.specialtyId = null;
            bookingState.doctorId = null;
            bookingState.date = null;
            bookingState.shiftId = null;
            bookingState.slotId = null;
            
            document.querySelectorAll('#departmentGrid .selection-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.id === departmentId);
            });
            
            loadSpecialties(departmentId);
            document.getElementById('btnStep2Next').disabled = false;
        }

        function selectSpecialty(specialtyId) {
            bookingState.specialtyId = specialtyId;
            bookingState.doctorId = null;
            bookingState.date = null;
            bookingState.shiftId = null;
            bookingState.slotId = null;
            
            document.querySelectorAll('#specialtyGrid .selection-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.id === specialtyId);
            });
            
            document.getElementById('btnStep3Next').disabled = false;
        }

        function selectDoctor(doctorId) {
            // Kiểm tra xem bác sĩ có khả dụng không
            const doctorCard = document.querySelector(`#doctorGrid .doctor-card[data-id="${doctorId}"]`);
            if (doctorCard && doctorCard.classList.contains('disabled')) {
                alert('Bác sĩ này không khả dụng trong ngày đã chọn. Vui lòng chọn bác sĩ khác!');
                return;
            }
            
            bookingState.doctorId = doctorId;
            bookingState.shiftId = null;
            bookingState.slotId = null;
            
            document.querySelectorAll('#doctorGrid .doctor-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.id === doctorId);
            });
            
            loadShifts();
            document.getElementById('btnStep4Next').disabled = false;
        }

        function selectShift(shiftId) {
            bookingState.shiftId = shiftId;
            bookingState.slotId = null;
            
            document.querySelectorAll('#shiftSelector .shift-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.shift) === shiftId);
            });
            
            loadAvailableSlots(shiftId);
            document.getElementById('btnStep5Next').disabled = true;
        }

        function selectSlot(slotId) {
            // Kiểm tra xem suất có khả dụng không
            const slotCard = document.querySelector(`#timeSlots .time-slot[data-slot="${slotId}"]`);
            if (slotCard && slotCard.classList.contains('disabled')) {
                alert('Suất khám này đã được đặt. Vui lòng chọn suất khác!');
                return;
            }
            
            bookingState.slotId = slotId;
            
            document.querySelectorAll('#timeSlots .time-slot').forEach(slot => {
                slot.classList.toggle('selected', parseInt(slot.dataset.slot) === slotId);
            });
            
            document.getElementById('btnStep5Next').disabled = false;
        }

        // === NAVIGATION ===

        function goToStep(stepNumber) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById('step' + stepNumber).classList.add('active');
            
            // Update step indicators
            const steps = document.querySelectorAll('.step');
            steps.forEach(s => {
                s.classList.remove('active', 'completed');
                const step = parseInt(s.dataset.step);
                if (step < stepNumber) s.classList.add('completed');
                if (step === stepNumber) s.classList.add('active');
            });
            
            // Update progress line
            const progressLine = document.getElementById('progressLine');
            const percent = ((stepNumber - 1) / (steps.length - 1)) * 100;
            progressLine.style.width = percent + '%';
            
            // Load data if needed
            if (stepNumber === 2 && !document.querySelector('#departmentGrid .selection-card')) {
                loadDepartments();
            }
        }

        // Button event listeners
        document.getElementById('btnStep1Next').addEventListener('click', () => goToStep(2));
        document.getElementById('btnStep2Next').addEventListener('click', () => goToStep(3));
        document.getElementById('btnStep3Next').addEventListener('click', () => goToStep(4));
        document.getElementById('btnStep4Next').addEventListener('click', () => goToStep(5));
        document.getElementById('btnStep5Next').addEventListener('click', () => {
            renderSummary();
            goToStep(6);
        });

        // === SUMMARY & SUBMIT ===

        async function renderSummary() {
            const container = document.getElementById('summaryCard');
            
            try {
                // Fetch all needed data
                const [packageRes, deptRes, specRes, docRes, shiftRes, slotRes] = await Promise.all([
                    fetch(`${API_BASE}/get-packages.php`),
                    fetch(`${API_BASE}/get-departments.php`),
                    fetch(`${API_BASE}/get-specialties.php?maKhoa=${bookingState.departmentId}`),
                    fetch(`${API_BASE}/get-available-doctors.php?maChuyenKhoa=${bookingState.specialtyId}&ngayKham=${bookingState.date}`),
                    fetch(`${API_BASE}/get-shifts.php`),
                    fetch(`${API_BASE}/get-available-slots.php?maBacSi=${bookingState.doctorId}&ngayKham=${bookingState.date}&maCa=${bookingState.shiftId}`)
                ]);
                
                const packages = (await packageRes.json()).data;
                const departments = (await deptRes.json()).data;
                const specialties = (await specRes.json()).data;
                const doctors = (await docRes.json()).data;
                const shifts = (await shiftRes.json()).data;
                const slots = (await slotRes.json()).data;
                
                const pkg = packages.find(p => p.maGoi === bookingState.packageId);
                const dept = departments.find(d => d.maKhoa === bookingState.departmentId);
                const spec = specialties.find(s => s.maChuyenKhoa === bookingState.specialtyId);
                const doc = doctors.find(d => d.maBacSi === bookingState.doctorId);
                const shift = shifts.find(s => s.maCa === bookingState.shiftId);
                const slot = slots.find(s => s.maSuat === bookingState.slotId);
                
                container.innerHTML = `
                    <div class="summary-item">
                        <div class="summary-label">Gói Khám:</div>
                        <div class="summary-value">${pkg.tenGoi} - ${Number(pkg.gia).toLocaleString('vi-VN')}đ</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Khoa:</div>
                        <div class="summary-value">${dept.tenKhoa}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Chuyên Khoa:</div>
                        <div class="summary-value">${spec.tenChuyenKhoa}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Bác Sĩ:</div>
                        <div class="summary-value">${doc.tenBacSi}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Ngày Khám:</div>
                        <div class="summary-value">${formatDate(bookingState.date)}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Ca Làm Việc:</div>
                        <div class="summary-value">${shift.tenCa}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Giờ Khám:</div>
                        <div class="summary-value">${slot.gioBatDau.substring(0, 5)} - ${slot.gioKetThuc.substring(0, 5)}</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error rendering summary:', error);
            }
        }

        async function submitBooking() {
            const notes = document.getElementById('notes').value;
            
            const bookingData = {
                maBenhNhan: bookingState.patientId,
                maBacSi: bookingState.doctorId,
                ngayKham: bookingState.date,
                maCa: bookingState.shiftId,
                maSuat: bookingState.slotId,
                maGoi: bookingState.packageId,
                ghiChu: notes
            };
            
            try {
                const response = await fetch(`${API_BASE}/create-appointment.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Đặt lịch thành công! Mã lịch khám: ' + data.maLichKham);
                    window.location.href = 'lichkham.html';
                } else {
                    alert('Đặt lịch thất bại: ' + data.message);
                }
            } catch (error) {
                console.error('Error submitting booking:', error);
                alert('Có lỗi xảy ra. Vui lòng thử lại!');
            }
        }

        // Helper function
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
        }
        
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }
    </script>
</body>
</html>